{% extends '/azure/base.html' %}

{% block title %}Index Page{% endblock %}

{% block content %}

<section class="content">
    <div class="row">
        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Access Key</h3>
                </div>
                <form role="form" id="accessKeyForm">
                    <div class="box-body">
                        <div class="form-group">
                            <label for="connectionString">Connection String</label>
                            <input type="text" class="form-control" id="connectionString" placeholder="Enter connection string">
                        </div>
                    </div>
                    <div class="box-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
            </div>

        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Workload Identity</h3>
                </div>
                <form role="form" id="workload-IdentityForm">
                    <div class="box-body">
                        </div>
                    <div class="box-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
            </div>
    </div>
    
    <div class="row" style="margin-top: 20px;">
        <div class="col-md-12">
            <div class="box box-success" id="resultBox" style="display: none;">
                <div class="box-header with-border">
                    <h3 class="box-title">결과</h3>
                </div>
                <div class="box-body">
                    <pre id="resultMessage"></pre>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accessKeyForm = document.getElementById('accessKeyForm');
    const workload_IdentityForm = document.getElementById('workload-IdentityForm');
    const resultBox = document.getElementById('resultBox');
    const resultMessage = document.getElementById('resultMessage');

    accessKeyForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // 기본 폼 제출 동작 방지

        const connectionString = document.getElementById('connectionString').value;
        if (!connectionString) {
            alert('Connection String을 입력해주세요.');
            return;
        }

        resultMessage.textContent = '처리 중...';
        resultBox.style.display = 'block';

        try {
            const response = await fetch('/StorageAccount/accesskey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ connection_string: connectionString })
            });

            const result = await response.json();

            if (response.ok) {
                resultMessage.textContent = result.message;
                resultBox.classList.remove('box-danger');
                resultBox.classList.add('box-success');
            } else {
                resultMessage.textContent = result.message || '알 수 없는 오류가 발생했습니다.';
                resultBox.classList.remove('box-success');
                resultBox.classList.add('box-danger');
            }

        } catch (error) {
            console.error('Fetch Error:', error);
            resultMessage.textContent = `오류가 발생했습니다: ${error.message}`;
            resultBox.classList.remove('box-success');
            resultBox.classList.add('box-danger');
        }
    });
    workload_IdentityForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // 기본 폼 제출 동작 방지

        // const connectionString = document.getElementById('connectionString').value;
        // if (!connectionString) {
        //     alert('Connection String을 입력해주세요.');
        //     return;
        // }

        resultMessage.textContent = '처리 중...';
        resultBox.style.display = 'block';

        try {
            const response = await fetch('/StorageAccount/workloadIdentity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ connection_string: connectionString })
            });

            const result = await response.json();

            if (response.ok) {
                resultMessage.textContent = result.message;
                resultBox.classList.remove('box-danger');
                resultBox.classList.add('box-success');
            } else {
                resultMessage.textContent = result.message || '알 수 없는 오류가 발생했습니다.';
                resultBox.classList.remove('box-success');
                resultBox.classList.add('box-danger');
            }

        } catch (error) {
            console.error('Fetch Error:', error);
            resultMessage.textContent = `오류가 발생했습니다: ${error.message}`;
            resultBox.classList.remove('box-success');
            resultBox.classList.add('box-danger');
        }
    });
});
</script>
{% endblock %}