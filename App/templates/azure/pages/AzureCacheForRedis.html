{% extends '/azure/base.html' %}

{% block title %}Index Page{% endblock %}

{% block content %}

<section class="content">
    <div class="row">
        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Access Key</h3>
                </div>
                <form role="form" id="accessKeyForm">
                    <div class="box-body">
                        <div class="form-group">
                            <label for="redis_host">REDIS HOST</label>
                            <input type="text" class="form-control" id="redis_host" placeholder="Enter Redis Host">
                            <label for="redis_host">REDIS PORT</label>
                            <input type="text" class="form-control" id="redis_port" placeholder="Enter Redis Port">
                            <label for="redis_host">REDIS USERNAME</label>
                            <input type="text" class="form-control" id="redis_username" placeholder="Enter Redis User name">
                            <label for="redis_host">REDIS PASSWORD</label>
                            <input type="text" class="form-control" id="redis_password" placeholder="Enter Redis Password">
                        </div>
                    </div>
                    <div class="box-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
            </div>

        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Workload Identity</h3>
                </div>
                <form role="form" id="workload-IdentityForm">
                    <div class="box-body">
                        <label for="redis_host">REDIS HOST</label>
                        <input type="text" class="form-control" id="redis_host_wi" placeholder="Enter Redis HOST">
                        <label for="redis_port">REDIS PORT</label>
                        <input type="text" class="form-control" id="redis_port_wi" placeholder="Enter Redis PORT">
                    </div>
                    <div class="box-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
            </div>
    </div>
    
    <div class="row" style="margin-top: 20px;">
        <div class="col-md-12">
            <div class="box box-success" id="resultBox" style="display: none;">
                <div class="box-header with-border">
                    <h3 class="box-title">결과</h3>
                </div>
                <div class="box-body">
                    <pre id="resultMessage"></pre>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accessKeyForm = document.getElementById('accessKeyForm');
    const workload_IdentityForm = document.getElementById('workload-IdentityForm');
    const resultBox = document.getElementById('resultBox');
    const resultMessage = document.getElementById('resultMessage');

    accessKeyForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // 기본 폼 제출 동작 방지

        const redis_host = document.getElementById('redis_host').value;
        if (!redis_host) {
            alert('redis_host을 입력해주세요.');
            return;
        }
        const redis_port = document.getElementById('redis_port').value;
        if (!redis_port) {
            alert('redis_port을 입력해주세요.');
            return;
        }
        const redis_username = document.getElementById('redis_username').value;
        if (!redis_username) {
            alert('redis_username을 입력해주세요.');
            return;
        }
        const redis_password = document.getElementById('redis_password').value;
        if (!redis_password) {
            alert('redis_password을 입력해주세요.');
            return;
        }

        resultMessage.textContent = '처리 중...';
        resultBox.style.display = 'block';

        try {
            const response = await fetch('/Redis/accesskey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    redis_host: redis_host,
                    redis_port: redis_port,
                    redis_username: redis_username,
                    redis_password: redis_password,
                 })
            });

            const result = await response.json();

            if (response.ok) {
                resultMessage.textContent = result.message;
                resultBox.classList.remove('box-danger');
                resultBox.classList.add('box-success');
            } else {
                resultMessage.textContent = result.message || '알 수 없는 오류가 발생했습니다.';
                resultBox.classList.remove('box-success');
                resultBox.classList.add('box-danger');
            }

        } catch (error) {
            console.error('Fetch Error:', error);
            resultMessage.textContent = `오류가 발생했습니다: ${error.message}`;
            resultBox.classList.remove('box-success');
            resultBox.classList.add('box-danger');
        }
    });


    workload_IdentityForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // 기본 폼 제출 동작 방지

        const redis_host = document.getElementById('redis_host_wi').value;
        if (!redis_host) {
            alert('redis_host을 입력해주세요.');
            return;
        }
        const redis_port = document.getElementById('redis_port_wi').value;
        if (!redis_port) {
            alert('redis_port을 입력해주세요.');
            return;
        }

        resultMessage.textContent = '처리 중...';
        resultBox.style.display = 'block';

        try {
            const response = await fetch('/Redis/workloadIdentity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    redis_host: redis_host,
                    redis_port: redis_port
                 })
            });

            const result = await response.json();

            if (response.ok) {
                resultMessage.textContent = result.message;
                resultBox.classList.remove('box-danger');
                resultBox.classList.add('box-success');
            } else {
                resultMessage.textContent = result.message || '알 수 없는 오류가 발생했습니다.';
                resultBox.classList.remove('box-success');
                resultBox.classList.add('box-danger');
            }

        } catch (error) {
            console.error('Fetch Error:', error);
            resultMessage.textContent = `오류가 발생했습니다: ${error.message}`;
            resultBox.classList.remove('box-success');
            resultBox.classList.add('box-danger');
        }
    });
});
</script>
{% endblock %}